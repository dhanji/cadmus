# Sieve of Eratosthenes: find all primes up to n
# Example: primes up to 30 = (2 3 5 7 11 13 17 19 23 29)
# expected: (2 3 5 7 11 13 17 19 23 29)

sieve_of_eratosthenes:
  inputs:
    - n: "Number"
  bindings:
    n: "30"
  steps:
    - add:
        x: "$n"
        y: "1"
    - make_vector:
        size: "$step-1"
        init: "#t"
    - vector_set:
        v: "$step-2"
        i: "0"
        val: "#f"
    - vector_set:
        v: "$step-2"
        i: "1"
        val: "#f"
    - sqrt: "$n"
    - exact_floor: "$step-5"
    - add:
        x: "$step-6"
        y: "1"
    - for_range:
        var: "i"
        start: "2"
        end: "$step-7"
        body:
          - when_do:
              test:
                vector_ref:
                  v: "$step-2"
                  i: "$i"
              body:
                - multiply:
                    x: "$i"
                    y: "$i"
                - for_range:
                    var: "j"
                    start: "$body-1"
                    end:
                      add:
                        x: "$n"
                        y: "1"
                    step: "$i"
                    body:
                      - vector_set:
                          v: "$step-2"
                          i: "$j"
                          val: "#f"
    - range:
        start: "2"
        end:
          add:
            x: "$n"
            y: "1"
    - fold:
        acc: "primes"
        init: "(list)"
        var: "i"
        over: "$step-9"
        body:
          - cond:
              clauses:
                - test:
                    vector_ref:
                      v: "$step-2"
                      i: "$i"
                  then:
                    - append:
                        x: "$primes"
                        y:
                          list_new: "$i"
                - else: "$primes"
