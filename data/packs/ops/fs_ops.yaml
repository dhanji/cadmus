# Filesystem Operations Pack
# ==========================
# Domain-specific typed operations for filesystem reasoning.
# Loaded at runtime by the ops pack loader — no Rust recompilation needed.
#
# Each op has:
#   name         — unique operation name
#   type_params  — polymorphic type variables (empty for monomorphic ops)
#   inputs       — input type expressions (parsed via TypeExpr::parse)
#   output       — output type expression
#   properties   — algebraic properties (commutative, associative, idempotent, etc.)
#   description  — human-readable hint (shown in dry-run traces)

name: filesystem
description: "POSIX/macOS filesystem operations"

ops:
  # --- Directory & File I/O ---

  - name: list_dir
    type_params: [a]
    inputs: ["Dir(a)"]
    output: "Seq(Entry(Name, a))"
    description: "ls — list directory contents"

  - name: read_file
    type_params: [a]
    inputs: ["File(a)"]
    output: "a"
    description: "cat — read file contents"

  - name: write_file
    type_params: [a]
    inputs: ["a", "Path"]
    output: "File(a)"
    description: "write content to file at path"

  - name: stat
    inputs: ["Path"]
    output: "Metadata"
    properties:
      idempotent: true
    description: "stat — get file metadata"

  - name: walk_tree
    type_params: [a]
    inputs: ["Dir(a)"]
    output: "Seq(Entry(Name, a))"
    description: "find — recursively walk directory tree (flattened)"

  - name: walk_tree_hierarchy
    type_params: [a]
    inputs: ["Dir(a)"]
    output: "Tree(Entry(Name, a))"
    description: "find — recursively walk directory tree (preserving hierarchy)"

  - name: flatten_tree
    type_params: [a]
    inputs: ["Tree(a)"]
    output: "Seq(a)"
    properties:
      idempotent: true
    description: "flatten tree structure into flat sequence"

  # --- Filtering & Sorting ---

  - name: filter
    type_params: [a]
    inputs: ["Seq(a)", "Pattern"]
    output: "Seq(a)"
    properties:
      idempotent: true
    description: "grep/filter — filter sequence by pattern"

  - name: sort_by
    type_params: [a]
    inputs: ["Seq(a)"]
    output: "Seq(a)"
    properties:
      idempotent: true
    description: "sort — sort sequence elements"

  # --- Archive Operations ---

  - name: extract_archive
    type_params: [a, fmt]
    inputs: ["File(Archive(a, fmt))"]
    output: "Seq(Entry(Name, a))"
    description: "extract archive contents (generic — resolved to format-specific op)"

  - name: pack_archive
    type_params: [a, fmt]
    inputs: ["Seq(Entry(Name, a))", "fmt"]
    output: "File(Archive(a, fmt))"
    description: "pack entries into archive (generic — resolved to format-specific op)"

  # Format-specific extract ops (resolved from extract_archive by the compiler)
  - name: extract_zip
    type_params: [a]
    inputs: ["File(Archive(a, Zip))"]
    output: "Seq(Entry(Name, a))"
    description: "unzip — extract ZIP/CBZ archive"

  - name: extract_tar
    type_params: [a]
    inputs: ["File(Archive(a, Tar))"]
    output: "Seq(Entry(Name, a))"
    description: "tar -xf — extract TAR archive"

  - name: extract_tar_gz
    type_params: [a]
    inputs: ["File(Archive(a, TarGz))"]
    output: "Seq(Entry(Name, a))"
    description: "tar -xzf — extract gzipped TAR archive"

  - name: extract_tar_bz2
    type_params: [a]
    inputs: ["File(Archive(a, TarBz2))"]
    output: "Seq(Entry(Name, a))"
    description: "tar -xjf — extract bzip2 TAR archive"

  - name: extract_tar_xz
    type_params: [a]
    inputs: ["File(Archive(a, TarXz))"]
    output: "Seq(Entry(Name, a))"
    description: "tar -xJf — extract xz TAR archive"

  - name: extract_rar
    type_params: [a]
    inputs: ["File(Archive(a, Rar))"]
    output: "Seq(Entry(Name, a))"
    description: "unrar x — extract RAR/CBR archive"

  # Format-specific pack ops
  - name: pack_zip
    type_params: [a]
    inputs: ["Seq(Entry(Name, a))"]
    output: "File(Archive(a, Zip))"
    description: "zip — create ZIP/CBZ archive"

  - name: pack_tar
    type_params: [a]
    inputs: ["Seq(Entry(Name, a))"]
    output: "File(Archive(a, Tar))"
    description: "tar -cf — create TAR archive"

  - name: pack_tar_gz
    type_params: [a]
    inputs: ["Seq(Entry(Name, a))"]
    output: "File(Archive(a, TarGz))"
    description: "tar -czf — create gzipped TAR archive"

  # --- Sequence Operations ---

  - name: concat_seq
    type_params: [a]
    inputs: ["Seq(a)", "Seq(a)"]
    output: "Seq(a)"
    properties:
      associative: true
      identity: "[]"
    description: "cat/concat — concatenate sequences (order-preserving)"

  - name: flatten_seq
    type_params: [a]
    inputs: ["Seq(Seq(a))"]
    output: "Seq(a)"
    properties:
      idempotent: true
    description: "flatten — collapse nested sequences into flat sequence (order-preserving)"

  - name: enumerate_entries
    type_params: [a]
    inputs: ["Seq(Entry(Name, a))"]
    output: "Seq(Entry(Name, a))"
    properties:
      idempotent: false
    description: "enumerate — rename entries with zero-padded sequential numbers (0001.ext, 0002.ext, ...)"

  # --- Entry Operations ---

  - name: rename
    type_params: [a]
    inputs: ["Entry(Name, a)", "Name"]
    output: "Entry(Name, a)"
    description: "mv — rename entry"

  - name: move_entry
    type_params: [a]
    inputs: ["Entry(Name, a)", "Path"]
    output: "Entry(Name, a)"
    description: "mv — move entry to new path"

  # --- Search ---

  - name: search_content
    inputs: ["Seq(Entry(Name, File(Text)))", "Pattern"]
    output: "Seq(Match(Pattern, Line))"
    description: "grep — search file contents for pattern"

  - name: find_matching
    type_params: [a]
    inputs: ["Pattern", "Seq(Entry(Name, a))"]
    output: "Seq(Entry(Name, a))"
    properties:
      idempotent: true
    description: "find -name — filter entries by name pattern"

  # --- Transformation ---

  - name: map_entries
    type_params: [a, b]
    inputs: ["Seq(Entry(Name, a))"]
    output: "Seq(Entry(Name, b))"
    description: "xargs/map — transform entry values"

  # =========================================================================
  # Phase 1: File Lifecycle
  # =========================================================================

  - name: copy
    type_params: [a]
    inputs: ["File(a)", "Path"]
    output: "File(a)"
    properties:
      idempotent: true
    description: "cp — copy file to destination path"

  - name: delete
    type_params: [a]
    inputs: ["Entry(Name, a)"]
    output: "Unit"
    description: "rm — delete file or directory"

  - name: create_dir
    inputs: ["Path"]
    output: "Dir(Bytes)"
    properties:
      idempotent: true
    description: "mkdir -p — create directory (and parents)"

  - name: create_link
    inputs: ["Path", "Path"]
    output: "Entry(Name, Bytes)"
    description: "ln -s — create symbolic link (target, link_name)"

  - name: set_permissions
    inputs: ["Path", "Permissions"]
    output: "Unit"
    properties:
      idempotent: true
    description: "chmod — set file permissions"

  - name: set_owner
    inputs: ["Path", "Owner"]
    output: "Unit"
    properties:
      idempotent: true
    description: "chown — set file owner"

  # =========================================================================
  # Phase 2: Content Transformation
  # =========================================================================

  - name: replace
    type_params: [a]
    inputs: ["File(a)", "Pattern", "Text"]
    output: "File(a)"
    description: "sed s/pattern/replacement/ — replace content in file"

  - name: head
    inputs: ["File(Text)", "Count"]
    output: "File(Text)"
    properties:
      idempotent: true
    description: "head -n — first N lines of file"

  - name: tail
    inputs: ["File(Text)", "Count"]
    output: "File(Text)"
    properties:
      idempotent: true
    description: "tail -n — last N lines of file"

  - name: unique
    type_params: [a]
    inputs: ["Seq(a)"]
    output: "Seq(a)"
    properties:
      idempotent: true
    description: "sort -u — deduplicate lines"

  - name: count
    type_params: [a]
    inputs: ["Seq(a)"]
    output: "Count"
    description: "wc -l — count elements in sequence"

  - name: diff
    inputs: ["File(Text)", "File(Text)"]
    output: "Diff"
    properties:
      commutative: false
    description: "diff — compare two text files"

  - name: checksum
    type_params: [a]
    inputs: ["File(a)"]
    output: "Hash"
    properties:
      idempotent: true
    description: "shasum — compute file checksum"

  # =========================================================================
  # Phase 3: Metadata Accessors
  # =========================================================================

  - name: get_size
    inputs: ["Metadata"]
    output: "Size"
    properties:
      idempotent: true
    description: "stat -f %z — extract file size from metadata"

  - name: get_mtime
    inputs: ["Metadata"]
    output: "Timestamp"
    properties:
      idempotent: true
    description: "stat -f %m — extract modification time from metadata"

  - name: get_permissions
    inputs: ["Metadata"]
    output: "Permissions"
    properties:
      idempotent: true
    description: "stat -f %p — extract permissions from metadata"

  - name: get_file_type
    inputs: ["Metadata"]
    output: "FileType"
    properties:
      idempotent: true
    description: "stat -f %T — extract file type from metadata"

  # =========================================================================
  # Phase 4: macOS-Specific Operations
  # =========================================================================

  - name: spotlight_search
    inputs: ["Pattern"]
    output: "Seq(Entry(Name, Bytes))"
    description: "mdfind — Spotlight search for files matching query"

  - name: get_xattr
    inputs: ["Path", "XattrKey"]
    output: "XattrValue"
    properties:
      idempotent: true
    description: "xattr -p — read extended attribute value"

  - name: set_xattr
    inputs: ["Path", "XattrKey", "XattrValue"]
    output: "Unit"
    properties:
      idempotent: true
    description: "xattr -w — set extended attribute"

  - name: remove_xattr
    inputs: ["Path", "XattrKey"]
    output: "Unit"
    properties:
      idempotent: true
    description: "xattr -d — remove extended attribute"

  - name: remove_quarantine
    inputs: ["Path"]
    output: "Unit"
    properties:
      idempotent: true
    description: "xattr -d com.apple.quarantine — remove quarantine flag"

  - name: open_file
    inputs: ["Path"]
    output: "Unit"
    description: "open — open file with default application"

  - name: open_with
    inputs: ["Path", "App"]
    output: "Unit"
    description: "open -a — open file with specific application"

  - name: reveal
    inputs: ["Path"]
    output: "Unit"
    description: "open -R — reveal file in Finder"

  - name: clipboard_copy
    type_params: [a]
    inputs: ["a"]
    output: "Unit"
    description: "pbcopy — copy content to clipboard"

  - name: clipboard_paste
    output: "Text"
    description: "pbpaste — paste content from clipboard"

  - name: read_plist
    inputs: ["File(Plist)"]
    output: "Plist"
    properties:
      idempotent: true
    description: "defaults read / plutil — read plist file"

  - name: write_plist
    inputs: ["Plist", "Path"]
    output: "File(Plist)"
    description: "defaults write / plutil — write plist file"

  # =========================================================================
  # Phase 5: Network & Download
  # =========================================================================

  - name: download
    inputs: ["URL"]
    output: "File(Bytes)"
    description: "curl -O — download file from URL"

  - name: upload
    type_params: [a]
    inputs: ["File(a)", "URL"]
    output: "Unit"
    description: "curl -T / scp — upload file to URL"

  - name: sync
    type_params: [a]
    inputs: ["Dir(a)", "Path"]
    output: "Dir(a)"
    properties:
      idempotent: true
    description: "rsync -a — synchronize directory to destination"
