# Workflow: Mega Project Audit
# ============================
# A 20-step pipeline that performs a comprehensive project audit.
# Uses two parallel type chains stitched together:
#
# Chain A (Seq domain, 8 steps): Dir → walk → find → filter → sort → unique → count
# Chain B (File(Text) domain, 12 steps): logfile → awk → sed → awk → sed → head → tail → ...
#
# Since the workflow DSL is a linear pipeline, we do Chain B (the longer one).

workflow: "Mega log analysis pipeline"

inputs:
  logfile: "/var/log/syslog.log"

steps:
  # 1. Extract timestamp + process + message
  - awk_extract:
      program: "{print $1, $2, $3, $5, $0}"

  # 2. Filter for error-level messages
  - sed_script:
      script: "/error\\|fail\\|panic\\|fatal/I!d"

  # 3. Normalize timestamps to ISO format
  - sed_script:
      script: "s/^\\([A-Z][a-z]*\\) \\([0-9]*\\) \\([0-9:]*\\)/\\1-\\2T\\3/g"

  # 4. Extract just process name and message
  - awk_extract:
      program: "{$1=$2=$3=\"\"; print $4, substr($0, index($0,$5))}"

  # 5. Remove leading whitespace
  - sed_script:
      script: "s/^[ \\t]*//"

  # 6. Collapse repeated spaces
  - sed_script:
      script: "s/  */ /g"

  # 7. Tag severity levels
  - sed_script:
      script: "s/panic/[PANIC]/gI; s/fatal/[FATAL]/gI; s/error/[ERROR]/gI; s/fail/[FAIL]/gI"

  # 8. Extract unique process names
  - awk_extract:
      program: "{print $1}"

  # 9. Sort alphabetically
  - sed_script:
      script: "s/[[:space:]]*$//"

  # 10. Remove empty lines
  - sed_script:
      script: "/^$/d"

  # 11. Add sequence numbers
  - awk_extract:
      program: "{printf \"%05d | %s\\n\", NR, $0}"

  # 12. Take first 500 entries
  - head:
      count: "500"

  # 13. Take last 200 (window into middle of dataset)
  - tail:
      count: "200"

  # 14. Add CSV header
  - sed_script:
      script: "1i\\SEQ|PROCESS|MESSAGE"

  # 15. Replace pipe delimiters with commas for CSV
  - sed_script:
      script: "s/|/,/g"

  # 16. Quote fields that contain spaces
  - sed_script:
      script: "s/\\([^,]*\\) \\([^,]*\\)/\"\\1 \\2\"/g"

  # 17. Remove trailing whitespace
  - sed_script:
      script: "s/[[:space:]]*$//"

  # 18. Indent all lines for report formatting
  - sed_script:
      script: "s/^/    /"

  # 19. Final line count annotation
  - awk_extract:
      program: "{print $0} END {printf \"\\n# Total lines: %d\\n\", NR}"

  # 20. Trim to final output
  - head:
      count: "250"
