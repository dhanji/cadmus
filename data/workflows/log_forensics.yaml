# Workflow: Server Log Forensics
# ===============================
# A 10-step pipeline that processes server logs through multiple
# text transformation stages. All ops in the File(Text) domain.
#
# Type chain: File(Text) throughout

workflow: "Server log forensics pipeline"

inputs:
  logfile: "/var/log/nginx/access.log"

steps:
  # Stage 1: Extract IP, timestamp, path, status
  - awk_extract:
      program: "{print $1, $4, $7, $9}"

  # Stage 2: Filter for 4xx/5xx errors using sed (delete non-matching)
  - sed_script:
      script: "/[45][0-9][0-9]/!d"

  # Stage 3: Strip bracket chars from timestamps
  - sed_script:
      script: "s/\\[//g; s/\\]//g"

  # Stage 4: Extract just IPs and paths
  - awk_extract:
      program: "{print $1, $3}"

  # Stage 5: Format as pipe-delimited
  - sed_script:
      script: "s/ / | /g"

  # Stage 6: Add line numbers
  - awk_extract:
      program: "{printf \"%04d %s\\n\", NR, $0}"

  # Stage 7: Take top 200
  - head:
      count: "200"

  # Stage 8: Trim to last 100
  - tail:
      count: "100"

  # Stage 9: Add report header
  - sed_script:
      script: "1i\\--- ERROR REPORT ---"

  # Stage 10: Final cleanup â€” remove blank lines
  - sed_script:
      script: "/^$/d"
